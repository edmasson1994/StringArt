<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Color String Art Generator</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
<div class="container">
    <div class="controls">
        <div class="control-group">
            <div class="file-input-wrapper" style="width: 60%; margin: 0 auto;">
                Browse Image
                <input type="file" id="imageLoader" accept="image/*">
            </div>
        </div>
        <div class="control-group">
            <h3>Image Settings</h3>
            <div class="slider-container">
                <label for="brightness">Brightness</label>
                <input type="range" id="brightness" min="0" max="200" value="100">
                <input type="number" class="slider-value" id="brightnessValue" min="0" max="200" value="100">
            </div>
            <div class="slider-container">
                <label for="contrast">Contrast</label>
                <input type="range" id="contrast" min="0" max="200" value="100">
                <input type="number" class="slider-value" id="contrastValue" min="0" max="200" value="100">
            </div>
            <div class="slider-container">
                <label for="saturation">Saturation</label>
                <input type="range" id="saturation" min="0" max="200" value="100">
                <input type="number" class="slider-value" id="saturationValue" min="0" max="200" value="100">
            </div>
        </div>
        <div class="control-group">
            <h3>String Art Parameters</h3>
            <div class="slider-container">
                <label for="resolution">Resolution</label>
                <select id="resolution" class="styled-select">
                    <option value="250">250x250 (Fast)</option>
                    <option value="500" selected>500x500 (Standard)</option>
                    <option value="750">750x750 (High)</option>
                    <option value="1000">1000x1000 (Ultra)</option>
                </select>
            </div>
            <div class="slider-container">
                <label for="artDiameter">Artwork Diameter (cm)</label>
                <input type="range" id="artDiameter" min="10" max="100" value="40">
                <input type="number" class="slider-value" id="artDiameterValue" min="10" max="100" value="40">
            </div>
            <div class="slider-container">
                <label for="pins">Number of Pins</label>
                <input type="range" id="pins" min="60" max="480" value="240">
                <input type="number" class="slider-value" id="pinsValue" min="60" max="480" value="240">
            </div>
            <div class="slider-container">
                <label for="lines">Number of Lines</label>
                <input type="range" id="lines" min="250" max="10000" value="3000">
                <input type="number" class="slider-value" id="linesValue" min="250" value="3000">
            </div>
            <div class="slider-container">
                <label for="opacity">Line Opacity</label>
                <input type="range" id="opacity" min="1" max="100" value="25">
                <input type="number" class="slider-value" id="opacityValue" min="1" max="100" value="25">
            </div>
            <div style="font-size: 0.8rem; color: #666; text-align: right; margin-top: -0.5rem; margin-bottom: 1rem; padding-right: 10px;">
                Estimated thread thickness: <span id="estimatedThreadThickness">...</span> mm
            </div>
            <div class="slider-container">
                <label for="minPinDistance">Min Pin Distance</label>
                <input type="range" id="minPinDistance" min="0" max="120" value="25">
                <input type="number" class="slider-value" id="minPinDistanceValue" min="0" max="120" value="25">
            </div>
            <div class="slider-container">
                <label for="pinDiameter">Pin Diameter (mm)</label>
                <input type="range" id="pinDiameter" min="0.25" max="3" step="0.05" value="1">
                <input type="number" class="slider-value" id="pinDiameterValue" min="0.25" max="3" step="0.05" value="1">
            </div>
            <div class="slider-container">
                <label for="centralPinEnabled">Enable Central Pin</label>
                <input type="checkbox" id="centralPinEnabled" style="width: 20px; height: 20px; flex-grow: 0;" checked>
            </div>
            <div class="slider-container">
                <label for="middlePinsEnabled">Enable Middle Pins</label>
                <input type="checkbox" id="middlePinsEnabled" style="width: 20px; height: 20px; flex-grow: 0;" checked>
            </div>
            <div id="middlePinControls" style="display: block; margin-top: 1rem;">
                <div class="slider-container">
                    <label for="middlePins">Number of Middle Pins</label>
                    <input type="range" id="middlePins" min="3" max="64" value="32">
                    <input type="number" class="slider-value" id="middlePinsValue" min="3" max="64" value="32">
                </div>
                <div class="slider-container">
                    <label for="middlePinDistance">Middle Pin Distance</label>
                    <input type="range" id="middlePinDistance" min="0.25" max="0.75" step="0.01" value="0.6">
                    <input type="number" class="slider-value" id="middlePinDistanceValue" min="0.25" max="0.75" step="0.01" value="0.6">
                </div>
            </div>
        </div>
        <div class="control-group">
            <div class="advanced-toggle" style="display: flex; align-items: center; cursor: pointer; margin-bottom: 1rem;" onclick="toggleAdvanced()">
                <h3 style="margin: 0; margin-right: 0.5rem;">Advanced</h3>
                <span id="advancedArrow" style="font-size: 0.8rem; transition: transform 0.2s;">â–¼</span>
            </div>
            <div id="advancedControls" style="display: none;">
                <div class="slider-container">
                    <label for="monoLines">Monochromatic Lines</label>
                    <input type="range" id="monoLines" min="0" max="10000" value="0">
                    <input type="number" class="slider-value" id="monoLinesValue" min="0" value="0">
                </div>
                <div class="slider-container">
                    <label for="maxRepeats">Max Line Repeats</label>
                    <input type="range" id="maxRepeats" min="1" max="20" value="5">
                    <input type="number" class="slider-value" id="maxRepeatsValue" min="1" max="20" value="5">
                </div>
                <div class="slider-container" style="margin-top: 1rem;">
                    <label for="generationStrategy">Generation Strategy</label>
                    <select id="generationStrategy" class="styled-select">
                        <option value="greedy" selected>Greedy (Fast)</option>
                        <option value="lookahead">Lookahead (Slow)</option>
                    </select>
                </div>
                <div id="lookaheadControls" style="display: none;">
                    <div class="slider-container">
                        <label for="lookaheadSampling">Lookahead Sampling</label>
                        <input type="range" id="lookaheadSampling" min="1" max="100" value="20">
                        <input type="number" class="slider-value" id="lookaheadSamplingValue" min="1" max="100" value="20">
                    </div>
                </div>
                <div class="slider-container">
                    <label for="normalizationMode">Score Normalization</label>
                    <select id="normalizationMode" class="styled-select">
                        <option value="none" selected>None</option>
                        <option value="average">Average per pixel</option>
                        <option value="logarithmic">Logarithmic bonus</option>
                    </select>
                </div>
                <div class="slider-container">
                    <label for="colorForcingEnabled">Enable Color Forcing</label>
                    <input type="checkbox" id="colorForcingEnabled" style="width: 20px; height: 20px; flex-grow: 0;">
                </div>
                <div id="colorForcingControls" style="display: none; margin-top: 1rem;">
                    <div class="slider-container">
                        <label for="colorForcingPercentage">Forcing Percentage</label>
                        <input type="range" id="colorForcingPercentage" min="0" max="100" value="20">
                        <input type="number" class="slider-value" id="colorForcingPercentageValue" min="0" max="100" value="20">
                    </div>
                    <!-- NEW: RGB Dominance Threshold -->
                    <div class="slider-container">
                        <label for="dominanceThreshold">RGB Dominance Threshold</label>
                        <input type="range" id="dominanceThreshold" min="0" max="255" value="30">
                        <input type="number" class="slider-value" id="dominanceThresholdValue" min="0" max="255" value="30">
                    </div>
                </div>
            </div>
        </div>
        <div class="control-group" id="backgroundColorGroup">
            <h3>Background Color</h3>
            <div class="compact-background-controls">
                <input type="color" id="backgroundColorPicker" value="#FFFFFF" title="Manual Background Color">
                <button id="analyzeBinnedBtn">Binned</button>
                <button id="analyzeAverageBtn">Average</button>
            </div>
            <div id="binnedPrecisionText" style="font-size: 0.75rem; color: #666; text-align: center; min-height: 1em;"></div>
        </div>
        <div class="control-group">
            <h3>Thread Palette</h3>
            <div class="slider-container">
                <label for="paletteMode">Palette Type</label>
                <select id="paletteMode" class="styled-select">
                    <option value="classic">Classic (RGBKW)</option>
                    <option value="extended-classic">Extended Classic</option>
                    <option value="vibrant">Vibrant</option>
                    <option value="super-extended">Super Extended</option>
                    <option value="low-saturation">Low Saturation</option>
                    <option value="greyscale">Greyscale (7 shades)</option>
                    <option value="smart">Smart Palette (from Image)</option>
                    <option value="smart-lines">Smart Palette (Line-based)</option>
                    <option value="custom">Custom</option>
                    <option value="black-white">Black & White</option>
                    <option value="black" selected>Black Only</option>
                    <option value="white">White Only</option>
                </select>
            </div>
            <div id="smartPaletteControls" style="display: none;">
                <div class="slider-container">
                    <label for="paletteColors">Num Colors</label>
                    <input type="range" id="paletteColors" min="2" max="10" value="5">
                    <input type="number" class="slider-value" id="paletteColorsValue" min="2" max="10" value="5">
                </div>
                <div id="foregroundSeparationControl">
                    <div class="slider-container">
                        <label for="foregroundThreshold">Foreground Separation</label>
                        <input type="range" id="foregroundThreshold" min="0" max="150" value="50">
                        <input type="number" class="slider-value" id="foregroundThresholdValue" min="0" max="150" value="50">
                    </div>
                </div>
                <button id="analyzePaletteBtn" style="margin-top: 1rem;">Analyze Palette from Image</button>
                <div id="palette-display-container" style="margin-top: 1rem;">
                    <label>Generated Palette:</label>
                    <div id="paletteDisplay"></div>
                </div>
            </div>
            <div id="customPaletteControls" style="display: none;">
                 <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                    <label style="margin-bottom: 0;">Custom Colors</label>
                    <button id="addCustomColorBtn" title="Add New Color">+</button>
                </div>
                <div id="customPalettePickerContainer" style="margin-top: 1rem; display: flex; flex-wrap: wrap; gap: 10px;">
                    <!-- Color pickers generated by JS -->
                </div>
            </div>
        </div>
        <div class="control-group">
            <button id="generateBtn">Generate</button>
            <div id="validation-message"></div>
        </div>
        <div id="generation-progress-container" class="control-group" style="display: none;">
            <div class="progress-bar-wrapper">
                <progress id="generationProgress" value="0"></progress>
                <span id="progressText" class="slider-value">0 / 0</span>
            </div>
            <div class="generation-buttons">
                <button id="pauseResumeBtn">Pause</button>
                <button id="stopBtn">Stop</button>
            </div>
        </div>
        <div class="control-group download-buttons">
            <button id="downloadResultsBtn">Download Results</button>
        </div>
    </div>
    <div class="display">
        <canvas id="sourceCanvas"></canvas>
        <canvas id="previewCanvas"></canvas>
        <div id="statsContainer" style="display: none; width: 100%; margin-top: 1rem; flex-direction: column; align-items: center;">
            <div id="similarityDisplay" style="text-align: center; font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem;">
                Similarity: <span id="similarityScore">N/A</span>
            </div>
            <canvas id="similarityGraphCanvas" style="height: 150px; border: 1px solid #ccc; border-radius: 4px; width: 100%;"></canvas>
        </div>
    </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="js/config.js"></script>
<script src="js/utils.js"></script>
<script src="js/main.js"></script>
</body>
</html>
